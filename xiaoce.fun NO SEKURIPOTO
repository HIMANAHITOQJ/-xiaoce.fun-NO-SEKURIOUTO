// ==UserScript==
// @name         çŒœç›å¤šæ¿å—æ¯æ—¥è°œé¢˜æ—¥æœŸé€‰æ‹©å™¨
// @namespace    http://tampermonkey.net/
// @version      0.4
// @description  åŽŒçƒ¦äº†æ¯å¤©åªèƒ½é‡å¤çŽ©ä¸€ä¸ªç­”æ¡ˆï¼Œæ•…å†™å‡ºç”¨äºŽæ›´æ¢ç­”æ¡ˆï¼Œç›®å‰åªæ”¯æŒçŒœç—…ï¼ŒçŒœèŒï¼ŒçŒœåŽŸ
// @match        https://xiaoce.fun/*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    // èŽ·å–å½“å‰æ¿å—ç±»åž‹
    const path = location.pathname;
    const typeMap = {
        '/genshin': 'genshin',
        '/guesscute': 'guess_cute',
        '/guessdisease': 'guess_disease',
        // å¯ä»¥ç»§ç»­æ·»åŠ å…¶å®ƒæ¿å—è·¯å¾„ä¸Ž type çš„æ˜ å°„
    };
    const currentType = typeMap[path];
    if (!currentType) return;

    const STORAGE_KEY = `xiaoce-daily-${currentType}-date`;

    // æ‹¦æˆª fetch è¯·æ±‚ï¼ŒåŠ¨æ€ä¿®æ”¹ date å‚æ•°
    const interceptFetch = (targetDate) => {
    const rawFetch = window.fetch;
    window.fetch = async function (...args) {
        let [url, config] = args;

        if (typeof url === 'string') {
            // åŽŸç¥ž GET è¯·æ±‚
            if (currentType === 'genshin' && url.includes(`/getStatus?type=${currentType}&date=`)) {
                url = url.replace(/date=\d+/, `date=${targetDate}`);
                return rawFetch.call(this, url, config);
            }

            // çŒœç—…/çŒœèŒ POST è¯·æ±‚
            const isCute = currentType === 'guess_cute' && url.includes('/guessCute/guess');
            const isDisease = currentType === 'guess_disease' && url.includes('/sendMessage');

            if ((isCute || isDisease) && config?.body) {
                let bodyStr;

                if (typeof config.body === 'string') {
                    bodyStr = config.body;
                } else if (config.body instanceof URLSearchParams) {
                    bodyStr = config.body.toString();
                } else {
                    // å°è¯•å…œåº•å¤„ç†
                    try {
                        bodyStr = await new Response(config.body).text();
                    } catch {
                        bodyStr = '';
                    }
                }

                const newBody = bodyStr.replace(/date=\d+/, `date=${targetDate}`);
                const newConfig = Object.assign({}, config, {
                    body: newBody,
                    headers: Object.assign({}, config.headers, {
                        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                    })
                });
                return rawFetch.call(this, url, newConfig);
            }
        }

        return rawFetch.apply(this, args);
    };
};

    // è®¾ç½®å½“å‰æ—¥æœŸå¹¶åˆ·æ–°
    const setDate = (date) => {
        localStorage.setItem(STORAGE_KEY, date);
        location.reload();
    };

    // èŽ·å–æ‰€æœ‰å¯ç”¨çš„åŽ†å²æ—¥æœŸ
    const fetchAvailableDates = async () => {
        const url = `https://xiaoce.fun/api/v0/quiz/daily/general/fetchActive?type=${currentType}`;
        const res = await fetch(url);
        const json = await res.json();
        return json.data || [];
    };

    // æ³¨å…¥é€‰æ‹©å™¨ UI
    const injectUI = (dates, currentDate) => {
        const panel = document.createElement('div');
        panel.style.position = 'fixed';
        panel.style.top = '10px';
        panel.style.left = '10px';
        panel.style.zIndex = '9999';
        panel.style.background = 'white';
        panel.style.border = '1px solid #aaa';
        panel.style.padding = '6px';
        panel.style.borderRadius = '6px';

        const select = document.createElement('select');
        for (const date of dates) {
            const option = document.createElement('option');
            option.value = date;
            option.textContent = date;
            if (date === currentDate) option.selected = true;
            select.appendChild(option);
        }
        select.onchange = () => setDate(select.value);

        const randomBtn = document.createElement('button');
        randomBtn.textContent = 'ðŸŽ²éšæœº';
        randomBtn.style.marginLeft = '5px';
        randomBtn.onclick = () => {
            const random = dates[Math.floor(Math.random() * dates.length)];
            setDate(random);
        };

        panel.appendChild(select);
        panel.appendChild(randomBtn);
        document.body.appendChild(panel);
    };

    // ä¸»æ‰§è¡Œé€»è¾‘
    (async () => {
        const availableDates = await fetchAvailableDates();
        const savedDate = localStorage.getItem(STORAGE_KEY) || availableDates.at(-1);
        interceptFetch(savedDate);
        injectUI(availableDates, savedDate);
    })();
})();
